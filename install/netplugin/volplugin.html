<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Installing Contiv Storage with Docker and Vagrant">

    <link rel="shortcut icon" href="/assets/images/favicon.png">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <title>Installing Contiv Storage with Docker and Vagrant - Contiv</title>

    <link href="/assets/stylesheets/application-f0d09056.css" rel="stylesheet"/>

    <!--[if lt IE 9]><script src="/assets/javascripts/html5shiv-099439cc.js"></script><script src="/assets/javascripts/respond.min-1eb35b04.js"></script><![endif]-->

    
  </head>

  <body id="page-Installing Contiv Storage with Docker and Vagrant" class=" page-Installing Contiv Storage with Docker and Vagrant layout-install page-sub">

<div id="header" class="navbar-static-top">
  <div class="container">
    <div class="row">
      
        <div class="navbar-header">
          <div class="navbar-brand">
            <a href="http://www.cisco.com"><img class="logo" src="/assets/images/cisco-b5d79772.png">
              <a class="logo" href="/">Contiv</a>
            </a>
          </div>
          
        </div>
        <div class="buttons hidden-xs">
          <nav role="navigation">
            <ul class="main-links nav navbar-nav navbar-left">
              <li class="first li-under"><a href="/install/index.html">Documentation</a></li>
              <li class="li-under"><a href="/articles/index.html">Articles</a></li>
              <li class="li-under"><a href="https://github.com/contiv" target="_blank">
                        GitHub
                        <i class="fa fa-github fa-lg"></i>
                        </a></li>
                    <li class="li-under"><a href="https://contiv.slack.com" target="_blank">
                        Slack
                        <i class="fa fa-slack fa-lg"></i>
                        </a></li>
                    <li><a href="https://twitter.com/projectcontiv" target="_blank">
                        Twitter
                        <i class="fa fa-twitter fa-lg"></i>
                        </a></li>
            </ul>
          </nav>
        </div>
      
    </div>
  </div>
</div>


<div class="sidebar-overlay"></div>


<aside id="sidebar" class="sidebar sidebar-default sidebar-fixed-right" role="navigation">
    
    <div class="sidebar-header header-cover">
        
        <div class="sidebar-image">
            <img src="/assets/images/logo-header@2x.png" width="49px" height="56px">
        </div>
    </div>

    
    <ul class="main nav sidebar-nav">
        <li class="first"><a href="/intro/index.html">Intro</a></li>
        <li class=""><a href="/docs/index.html">Docs</a></li>
    </ul>
    <div class="divider"></div>
    
    <ul class="external nav sidebar-nav">
        <li class=""><a class="v-btn gray sml" href="https://github.com/contiv"><svg id="svg-download" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 14 14" style="enable-background:new 0 0 14 14;">
  <style>
  </style>
  <path class="" d="M13,0H1C0.5,0,0,0.5,0,1v12c0,0.5,0.5,1,1,1h4.7c0,0,0,0,0-0.1c0-0.2,0-0.6,0-1.1c-1.8,0.4-2.2-0.9-2.2-0.9
    c-0.3-0.8-0.7-1-0.7-1c-0.6-0.4,0-0.4,0-0.4c0.7,0,1,0.7,1,0.7c0.6,1,1.5,0.7,1.9,0.5c0.1-0.4,0.2-0.7,0.4-0.9c-1.5-0.2-3-0.7-3-3.2
    c0-0.7,0.3-1.3,0.7-1.8C3.7,5.8,3.5,5.1,3.9,4.2c0,0,0.6-0.2,1.8,0.7c0.5-0.1,1.1-0.2,1.6-0.2c0.6,0,1.1,0.1,1.6,0.2
    c1.3-0.8,1.8-0.7,1.8-0.7c0.4,0.9,0.1,1.6,0.1,1.7c0.4,0.5,0.7,1,0.7,1.8c0,2.5-1.5,3.1-3,3.2C8.7,11.1,9,11.5,9,12.1
    c0,0.9,0,1.6,0,1.8c0,0,0,0,0,0.1h4c0.5,0,1-0.5,1-1V1C14,0.5,13.5,0,13,0z"/>
</svg>
GitHub</a></li>
    </ul>
</aside>


<div class="container">
	<div class="row">
		<div class="col-md-3 col-sm-3 col-xs-12">
					<div class="docs-sidebar hidden-print affix-top" role="complementary">
			<hr>
			<h3>User Guide</h3>
			<ul class="nav docs-sidenav">
				<li class="active">
					<a data-toggle="collapse" href="#collapse100" href="/install/user_guides/getting_started/index.html">Getting Started</a>
				<div id="collapse100" class="panel-collapse collapse">

					<ul class="nav nav-visible">
						<li>
							<a href="/install/user_guides/getting_started/community_talks/index.html">Talks and Demonstrations</a>
						</li>
						<li>
							<a data-toggle="collapse" href="#collapse110" href="/install/user_guides/getting_started/networking/index.html">Networking</a>
									<div id="collapse110" class="panel-collapse collapse">
										<ul>
											<li class="active">
													<a href="/install/user_guides/getting_started/networking/vagrant.html">Development Setup with Vagrant</a>
											</li>
											<li>
													<a href="/install/user_guides/getting_started/networking/mcast.html">Multicast Demonstration</a>
											</li>
											<li>
													<a href="/install/user_guides/getting_started/networking/basic_server_setup.html">Basic Server Setup</a>
											</li>
											<li>
													<a href="/install/user_guides/getting_started/networking/swarm.html">Docker Swarm</a>
											</li>
											<li>
													<a href="/install/user_guides/getting_started/networking/k8s.html">Kubernetes</a>
											</li>
											<li>
													<a href="/install/user_guides/getting_started/networking/mesos.html">Mesos</a>
											</li>
											<li>
													<a href="/install/user_guides/getting_started/networking/nomad.html">Nomad</a>
											</li>
											<li>
													<a href="/install/user_guides/getting_started/networking/bgp.html">BGP</a>
											</li>
										</ul>
									</div>

						</li>
						<li>
							<a data-toggle="collapse" href="#collapse120" href="/install/user_guides/getting_started/network_topologies/index.html">Network Topologies</a>
							<div id="collapse120" class="panel-collapse collapse">
								<ul class="nav">
									<li>
										<a href="/install/user_guides/getting_started/network_topologies/native_routed.html">Native Routing</a>
									</li>
									<li>
										<a href="/install/user_guides/getting_started/network_topologies/native_bridged.html">Native Bridging</a>
									</li>
									<li>
										<a href="/install/user_guides/getting_started/network_topologies/openstack.html">Openstack Deployment</a>
									</li>
									<li>
										<a href="/install/user_guides/getting_started/network_topologies/cloud.html">Cloud Deployment</a>
									</li>
									<li>
										<a href="/install/user_guides/getting_started/network_topologies/vagrant.html">Vagrant Setup</a>
									</li>
									<li>
										<a href="/install/user_guides/getting_started/network_topologies/networking101.html">Containers Networking Tutorial</a>
									</li>
									<li>
										<a href="/install/user_guides/getting_started/network_topologies/bgp.html">BGP</a>
									</li>
								</ul>
							</div>
						</li>
						<li>
							<a data-toggle="collapse" href="#collapse130" href="/install/user_guides/getting_started/storage/index.html">Storage </a>
							<div id="collapse130" class="panel-collapse collapse">
								<ul class="nav">
									<li><a href="/install/user_guides/getting_started/storage/swarm.html">Docker Swarm</a></li>
								</ul>
							</div>
						</li>
						<li>
							<a data-toggle="collapse" href="#collapse140" href="/install/user_guides/getting_started/storage_systems/index.html">Storage Systems</a>
							<div id="collapse140" class="panel-collapse collapse">
								<ul class="nav">
									<li><a href="/install/user_guides/getting_started/storage_systems/ceph.html">Ceph</a></li>
									<li><a href="/install/user_guides/getting_started/storage_systems/nfs.html">NFS</a></li>
								</ul>
							</div>
						</li>
					</ul>
				</div>
				</li>
				<li><a data-toggle="collapse" href="#collapse200" href="/install/user_guides/networking/index.html">Networking</a>
					<div id="collapse200" class="panel-collapse collapse">
						<ul class="nav nav-visible">
							<li><a href="/install/user_guides/networking/concepts.html">Terminology</a></li>
							<li><a href="/install/user_guides/networking/networks.html">Networks</a></li>
							<li><a href="/install/user_guides/networking/tenants.html">Tenants</a></li>
							<li><a href="/install/user_guides/networking/policies.html">Policies</a></li>
							<li><a href="/install/user_guides/networking/external_connectivity.html">External Connectivity</a></li>
							<li><a href="/install/user_guides/networking/service_discovery.html">Service Discovery</a></li>
							<li><a href="/install/user_guides/networking/ipam.html">IP Address Management</a></li>
							<li> <a href="/install/user_guides/networking/hybrid_workloads.html">Hybrid Workloads</a></li>
						</ul>
					</div>
				</li>
				<li><a data-toggle="collapse" href="#collapse300" href="/install/user_guides/storage/index.html">Storage</a>
					<div id="collapse300" class="panel-collapse collapse">
						<ul class="nav nav-visible">
							<li><a href="/install/user_guides/storage/concepts.html">Terminology</a></li>
							<li><a data-toggle="collapse" href="#collapse320" href="/install/user_guides/storage/policies/index.html">Policies</a></li>
								<div id="collapse320" class="panel-collapse collapse">
									<ul class="nav nav-visible">
										<li>
											<a href="/install/user_guides/storage/policies/allocation.html">Allocation</a></li>
										<li>
											<a href="/install/user_guides/storage/policies/rate_limiting.html">IOPs Rate Limiting</a></li>
										<li>
											<a href="/install/user_guides/storage/policies/snapshots.html">Snapshots</a></li>
										<li>
											<a href="/install/user_guides/storage/policies/filesystem.html">FileSystem</a></li>
									</ul>
								</div>
							<li><a href="/install/user_guides/storage/ceph.html">Ceph</a></li>
							<li><a href="/install/user_guides/storage/nfs.html">NFS</a></li>
						</ul>
					</div>
				</li>
				<li>
					<a data-toggle="collapse" href="#collapse400" href="/install/user_guides/cluster/index.html">Cluster</a>
					<div id="collapse400" class="panel-collapse collapse">
						<ul class="nav">
								<li><a href="/install/user_guides/cluster/concepts.html">Terminology</a></li>
								<li><a href="/install/user_guides/cluster/discovery.html">Discovery</a></li>
								<li><a href="/install/user_guides/cluster/commissioning.html">Commissioning and Decommissioning</a></li>
						</ul>
					</div>
				</li>
				<hr><p>
				<h3>Reference</h3>
					<ul class="nav nav-visible">
						<li><a href="https://godoc.org/github.com/contiv/netplugin">Network API Reference</a><br></li>
						<li><a href="https://godoc.org/github.com/contiv/contivmodel/client">Storage API Reference</a><br></li>
						<li><a href="https://godoc.org/github.com/contiv/cluster">Cluster API Reference</a><br></li>
					</ul>
				<hr><p>
				<h3>Examples</h3>
					<ul class="nav nav-visible">
						<li><a href="/install/samples/index.html">Example Use Cases</a><br></li>
					</ul>
				<hr><p>

				</li>
			</ul>
		</div>

		</div>  
		<div id="main-content" class="col-sm-9 col-md-9 col-xs-12" role="main">
			<div class="bs-docs-section">
				
	<h1>Contiv Storage</h1>
<p>Contiv Volume <a title="Title" href="https://github.com/contiv/volplugin">volplugin</a>
is a Ceph volume driver, and policy system that works well within a Docker
ecosystem. It can automatically move your storage with your containers, rather
than pinning containers to specific hosts to take advantage of their storage.</p>

<h2>Getting started</h2>
<p>Getting started describes setting up a test environment with three VMs. Once
the test environment is setup see the <a href="#Configure Services"><strong>Configure Services</strong></a>.</p>

<h4>Prerequisites</h4>
<p>Please read and follow the instructions in the prerequisites section of the
volplugin
<a href="https://github.com/contiv/volplugin/blob/master/README.md#prerequisites">README</a>
before completing the following:</p>

<h3>Clone and build the project</h3>

<h3>On Linux (without a VM)</h3>
<p>Clone the project:</p>
<pre class="highlight plaintext"><code>git clone https://github.com/contiv/volplugin
</code></pre>
<p>Build the project:</p>
<pre class="highlight plaintext"><code>make run-build
</code></pre>
<p>The command <code>make run-build</code> installs utilities for building the software in
the <code>$GOPATH</code>, as well as the <code>volmaster</code>, <code>volplugin</code> and <code>volcli</code> utilities.</p>

<h3>Everywhere else (with a VM):</h3>
<p>Clone the project:</p>
<pre class="highlight plaintext"><code>git clone https://github.com/contiv/volplugin
</code></pre>
<p>Build the project:</p>
<pre class="highlight plaintext"><code>make start
</code></pre>
<p>The build and binaries will be on the VM in the following directory <code>/opt/golang/bin</code>.</p>

<h2>Do it yourself</h2>

<h3>Installing Dependencies</h3>
<p>Use the Contiv <a href="https://github.com/contiv/volplugin/releases">nightly releases</a>
when following these steps:</p>
<p><strong>Note:</strong> Using the nightly builds is simpler than building the applications.</p>
<p>Install the dependencies in the following order:</p>

<ol>
<li><p>Follow the <a href="https://github.com/coreos/etcd/releases/tag/v2.2.0">Getting Started</a> to install <a href="https://coreos.com/etcd/docs/latest/getting-started-with-etcd.html">Etcd</a>.</p>

<ul>
<li>Currently versions 2.0 and later are supported.
</li>
</ul>
</li>
<li><p>Follow the <a href="http://docs.ceph.com/docs/master/install/">Ceph Installation Guide</a> to install <a href="http://ceph.com">Ceph</a>.</p>
</li>
<li><p>Configure Ceph with <a href="https://github.com/ceph/ceph-ansible">Ansible</a>.</p>
</li>
</ol>
<p><strong>Note</strong>: See the <a href="https://github.com/contiv/volplugin/blob/master/README.md#running-the-processes">README</a>
  for pre-configured VMs that work on any UNIX operating system to simplify
    Ceph installation.</p>

<ol>
<li><p>Upload a global configuration. You can find an example one <a href="https://github.com/contiv/volplugin/blob/master/systemtests/testdata/global1.json">here</a></p>
</li>
<li><p>Start volmaster (as root):</p>
</li>
</ol>
<pre class="highlight plaintext"><code>volmaster &amp;
</code></pre>
<p><strong>Note</strong>: volmaster debug mode is very noisy and is not recommended for
production use. Therefore, avoid using it with background processes. volplugin
currently connects to volmaster using port 9005, however in the future it is
variables.</p>

<ol>
<li>Start volsupervisor (as root):
</li>
</ol>
<pre class="highlight plaintext"><code>volsupervisor &amp;
</code></pre>
<p><strong>Note</strong>: volsupervisor debug mode is very noisy and is not recommended for production.</p>

<ol>
<li> Start volplugin (as root):
</li>
</ol>
<pre class="highlight plaintext"><code>volplugin &amp;
</code></pre>
<p>If running volplugin on multiple hosts, use the <code>--master</code> flag to
provide a ip:port pair to connect to over http. By default it connects to
<code>127.0.0.1:9005</code>.</p>

<h2>Configure Services</h2>
<p>Ensure Ceph is fully operational, and that the <code>rbd</code> tool works as root.</p>
<p>Upload a policy:</p>
<pre class="highlight plaintext"><code>volcli policy upload policy1 &lt; mypolicy.json
</code></pre>
<p><strong>Note</strong>: It accepts the policy from stdin, e.g.: <code>volcli policy upload policy1 &lt; mypolicy.json</code>
Examples of a policy are in <a href="https://github.com/contiv/volplugin/tree/master/systemtests/testdata">systemtests/testdata</a>.</p>

<h3>Creating a container with a volume</h3>
<p>Create a volume that refers to the volplugin driver:</p>
<pre class="highlight plaintext"><code>docker volume create -d volplugin --name policy1/test
</code></pre>
<p><strong>Notes</strong>:</p>

<ul>
<li><a name="test"/><a href="#test"><code>test</code></a> is the name of the volume, and is located under policy <code>policy1</code>,
which is uploaded with <code>volcli policy upload.</code>
</li>
<li>The volume will inherit the properties of the policy. Therefore, the
volume will be of appropriate size, iops, etc.
</li>
<li>There are numerous options (see below) to declare overrides of most parameters in the policy configuration.
</li>
<li>Run a container that uses the policy:
</li>
</ul>
<pre class="highlight plaintext"><code>docker run -it -v policy1/test:/mnt ubuntu bash
</code></pre>

<ul>
<li>Run <a name="mount_grep_mnt"/><a href="#mount_grep_mnt"><code>mount | grep /mnt</code></a> in the container.
</li>
</ul>
<p><strong>Note</strong>: <code>/dev/rbd#</code>should be attached to that directory.</p>

<ul>
<li>Once a multi-host system is setup, anytime the volume is not mounted, it
can be mounted on any host that has a connected rbd client available, and
volplugin running.
</li>
</ul>

<h2>Architecture</h2>
<p>&quot;volplugin&quot;, despite the name, is actually a suite of components:</p>
<p><code>volmaster</code> is the master process. It exists to coordinate the volplugins in a
way that safely manages container volumes. It talks to <code>etcd</code> to keep its
state.</p>
<p><code>volplugin</code> is the slave process. It exists to bridge the state management
between <code>volmaster</code> and <code>docker</code>, and to mount volumes on specific hosts.</p>
<p><code>volcli</code> is a utility for managing <code>volmaster</code>&#39;s data. It makes both REST calls
into the volmaster and additionally can write directly to etcd.</p>

<h3>Organizational Architecture</h3>
<p><code>volmaster</code> is completely stateless, and can be run multi-host for redundancy.
<code>volmaster</code> needs both root permissions, and capability to manipulate RBD
images with the <code>rbd</code> tool.</p>
<p><code>volsupervisor</code> handles scheduled and supervised tasks such as snapshotting. It
may only be deployed on one host at a time.</p>
<p><code>volplugin</code> needs to run on every host that will be running containers. Upon
start, it will create a unix socket in the appropriate plugin path so that
docker recognizes it. This creates a driver named <code>volplugin</code>.</p>
<p><code>volcli</code> is a management tool and can live anywhere that has access to the etcd
cluster and volmaster.</p>

<h3>Security Architecture</h3>
<p>There is none currently. This is still an alpha, security will be a beta
target.</p>

<h3>Network Architecture</h3>
<p><code>volmaster</code>, by default, listens on <code>0.0.0.0:9005</code>. It provides a REST
interface to each of its operations that are used both by <code>volplugin</code> and
<code>volcli</code>. It connects to etcd at <code>127.0.0.1:2379</code>, which you can change by
supplying <code>--etcd</code> one or more times.</p>
<p><code>volsupervisor</code> needs root, connections to etcd, and access to ceph <code>rbd</code> tools
as admin.</p>
<p><code>volplugin</code> contacts the volmaster but listens on no network ports (it uses a
unix socket as described above, to talk to docker). It by default connects to
the volmaster at <code>127.0.0.1:9005</code> and must be supplied the <code>--master</code> switch to
talk to a remote <code>volmaster</code>.</p>
<p><code>volcli</code> talks to both <code>volmaster</code> and <code>etcd</code> to communicate various state and
operations to the system.</p>

<h2>Configuration</h2>
<p>This section describes various ways to manipulate volplugin through
configuration and options.</p>

<h3>Volume Formatting</h3>
<p>Because of limitations in the docker volume implementation, we use a <em>pattern</em>
to describe volumes to docker. This pattern is <code>policy-name/volume-name</code>, and
is supplied to <code>docker volume create --name</code> and transfers to <code>docker run -v</code>.</p>
<p>For example, a typical use of volplugin might work like this presuming we have
a policy uploaded named <code>policy1</code>:</p>
<pre class="highlight plaintext"><code>$ docker volume create -d volplugin --name policy1/foo
$ docker run -it -v policy1/foo:/mnt ubuntu bash
</code></pre>
<p>This pattern creates a volume called <code>foo</code> in <code>policy1</code>&#39;s default ceph pool. If
you wish to change the pool (or other options), see &quot;Driver Options&quot; below.</p>

<h3>JSON Global Configuration</h3>
<p>Global configuration modifies the whole system through the volmaster, volplugin
and volsupervisor systems. You can manipulate them with the <code>volcli global</code>
command set.</p>
<p>A global configuration looks like this:</p>
<pre class="highlight javascript"><code><span class="p">{</span>
  <span class="s2">"TTL"</span><span class="err">:</span> <span class="mi">60</span><span class="p">,</span>
  <span class="s2">"Debug"</span><span class="err">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="s2">"Timeout"</span><span class="err">:</span> <span class="mi">5</span><span class="p">,</span>
  <span class="s2">"MountPath"</span><span class="err">:</span> <span class="s2">"/mnt/ceph"</span>
<span class="p">}</span>
</code></pre>
<p>Options:</p>

<ul>
<li>TTL: time (in seconds) for a mount record to timeout in the event a volplugin dies
</li>
<li>Debug: boolean value indicating whether or not to enable debug traps/logging
</li>
<li>Timeout: time (in minutes) for a command to be terminated if it exceeds this value
</li>
<li>MountPath: the base path used for mount directories. Directories will be in
<a name="policy_volume"/><a href="#policy_volume"><code>policy/volume</code></a> format off this root.
</li>
</ul>

<h3>JSON Tenant Configuration</h3>
<p>Tenant configuration uses JSON to configure the default volume parameters such
as what pool to use. It is uploaded to etcd by the <code>volcli</code> tool.</p>
<p>Here is an example:</p>
<pre class="highlight javascript"><code><span class="p">{</span>
  <span class="s2">"backends"</span><span class="err">:</span> <span class="p">{</span>
    <span class="s2">"crud"</span><span class="err">:</span> <span class="s2">"ceph"</span><span class="p">,</span>
    <span class="s2">"mount"</span><span class="err">:</span> <span class="s2">"ceph"</span><span class="p">,</span>
    <span class="s2">"snapshot"</span><span class="err">:</span> <span class="s2">"ceph"</span>
  <span class="p">},</span>
  <span class="s2">"unlocked"</span><span class="err">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="s2">"driver"</span><span class="err">:</span> <span class="p">{</span>
    <span class="s2">"pool"</span><span class="err">:</span> <span class="s2">"rbd"</span>
  <span class="p">},</span>
  <span class="s2">"create"</span><span class="err">:</span> <span class="p">{</span>
    <span class="s2">"size"</span><span class="err">:</span> <span class="s2">"10MB"</span><span class="p">,</span>
    <span class="s2">"filesystem"</span><span class="err">:</span> <span class="s2">"btrfs"</span>
  <span class="p">},</span>
  <span class="s2">"runtime"</span><span class="err">:</span> <span class="p">{</span>
    <span class="s2">"snapshots"</span><span class="err">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="s2">"snapshot"</span><span class="err">:</span> <span class="p">{</span>
      <span class="s2">"frequency"</span><span class="err">:</span> <span class="s2">"30m"</span><span class="p">,</span>
      <span class="s2">"keep"</span><span class="err">:</span> <span class="mi">20</span>
    <span class="p">},</span>
    <span class="s2">"rate-limit"</span><span class="err">:</span> <span class="p">{</span>
      <span class="s2">"write-iops"</span><span class="err">:</span> <span class="mi">1000</span><span class="p">,</span>
      <span class="s2">"read-iops"</span><span class="err">:</span> <span class="mi">1000</span><span class="p">,</span>
      <span class="s2">"write-bps"</span><span class="err">:</span> <span class="mi">100000000</span><span class="p">,</span>
      <span class="s2">"read-bps"</span><span class="err">:</span> <span class="mi">100000000</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="s2">"filesystems"</span><span class="err">:</span> <span class="p">{</span>
    <span class="s2">"ext4"</span><span class="err">:</span> <span class="s2">"mkfs.ext4 -m0 %"</span><span class="p">,</span>
    <span class="s2">"btrfs"</span><span class="err">:</span> <span class="s2">"mkfs.btrfs %"</span><span class="p">,</span>
    <span class="s2">"falsefs"</span><span class="err">:</span> <span class="s2">"/bin/false"</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<p>Let&#39;s go through what these parameters mean.</p>

<ul>
<li><a name="unlocked"/><a href="#unlocked"><code>unlocked</code></a>: removes the exclusive locks between mounts for a given volume.

<ul>
<li>This is a protective measure and is <em>not needed</em> to use NFS, so this flag
will turn it off (by setting it to true) if desired for a given policy.
</li>
</ul>
</li>
<li><code>filesystems</code>: a policy-level map of filesystem name -&gt; mkfs command.

<ul>
<li>Commands are run when the filesystem is specified and the volume has not
been created already.
</li>
<li>Commands run in a POSIX (not bash, zsh) shell.
</li>
<li>If the <a name="filesystems"/><a href="#filesystems"><code>filesystems</code></a> block is omitted, <code>mkfs.ext4 -m0 %</code> will be applied to
all volumes within this policy.
</li>
<li>Referred to by the volume create-time parameter <a name="filesystem"/><a href="#filesystem"><code>filesystem</code></a>. Note that you
can use a <code>%</code> to be replaced with the device to format.
</li>
</ul>
</li>
<li><code>backends</code>: the storage backends to use for different operations. Note that
not all drivers are compatible with each other. This is still an area with
work being done on it. Ceph and NFS are supported as <code>mount</code> options, <code>crud</code>
and <code>snapshot</code> operations require Ceph for now. Both driver names are lower-case.

<ul>
<li><a name="crud"/><a href="#crud"><code>crud</code></a>: Create/Delete operations driver name
</li>
<li><a name="mount"/><a href="#mount"><code>mount</code></a>: Mount operations driver name
</li>
<li><a name="snapshot"/><a href="#snapshot"><code>snapshot</code></a>: Snapshot operations
</li>
</ul>
</li>
<li><code>driver</code>: driver-specific options.

<ul>
<li><a name="pool"/><a href="#pool"><code>pool</code></a>: the ceph pool to use
</li>
</ul>
</li>
<li><code>create</code>: create-time options.

<ul>
<li><a name="size"/><a href="#size"><code>size</code></a>: the size of the volume
</li>
<li><a name="filesystem"/><a href="#filesystem"><code>filesystem</code></a>: the filesystem to use, see <code>filesystems</code> above.
</li>
</ul>
</li>
<li><code>runtime</code>: runtime options. These options can be changed and the changes will
be applied to mounted volumes almost immediately.

<ul>
<li><a name="snapshots"/><a href="#snapshots"><code>snapshots</code></a>: use the snapshots feature
</li>
<li><a name="snapshot"/><a href="#snapshot"><code>snapshot</code></a>: map of the following parameters:
</li>
<li><a name="frequency"/><a href="#frequency"><code>frequency</code></a>: the amount of time between taking snapshots.
</li>
<li><a name="keep"/><a href="#keep"><code>keep</code></a>: the number of snapshots to keep. the oldest ones will be deleted first.
</li>
<li><a name="rate_limit"/><a href="#rate_limit"><code>rate-limit</code></a>: map of the following rate-limiting parameters:
</li>
<li><a name="write_iops"/><a href="#write_iops"><code>write-iops</code></a>: Write I/O weight 
</li>
<li><a name="read_iops"/><a href="#read_iops"><code>read-iops</code></a>: Read I/O weight
</li>
<li><a name="write_bps"/><a href="#write_bps"><code>write-bps</code></a>: Write bytes/s
</li>
<li><a name="read_bps"/><a href="#read_bps"><code>read-bps</code></a>: Read bytes/s
</li>
</ul>
</li>
</ul>
<p>You supply them with <code>volcli policy upload &lt;policy name&gt;</code>. The JSON itself is
provided via standard input, so for example if your file is <code>policy2.json</code>:</p>
<pre class="highlight plaintext"><code>$ volcli policy upload myTenant &lt; policy2.json
</code></pre>

<h3>Driver Options</h3>
<p>Driver options are passed at <code>docker volume create</code> time with the <code>--opt</code> flag.
They are <code>key=value</code> pairs and are specified as such, f.e.:</p>
<pre class="highlight plaintext"><code>docker volume create -d volplugin \
  --name policy2/image \
  --opt size=1000
</code></pre>
<p>The options are as follows:</p>

<ul>
<li><a name="size"/><a href="#size"><code>size</code></a>: the size (in MB) for the volume.
</li>
<li><code>snapshots</code>: take snapshots or not. Affects future options with <code>snapshot</code> in the key name.

<ul>
<li>the value must satisfy <a href="https://golang.org/pkg/strconv/#ParseBool">this specification</a>
</li>
</ul>
</li>
<li><a name="snapshots_frequency"/><a href="#snapshots_frequency"><code>snapshots.frequency</code></a>: as above in the previous chapter, the frequency which we
take snapshots.
</li>
<li><a name="snapshots_keep"/><a href="#snapshots_keep"><code>snapshots.keep</code></a>: as above in the previous chapter, the number of snapshots to keep.
</li>
<li><a name="filesystem"/><a href="#filesystem"><code>filesystem</code></a>: the named filesystem to create. See the JSON Configuration
section for more information on this.
</li>
<li><a name="rate_limit_write_iops"/><a href="#rate_limit_write_iops"><code>rate-limit.write.iops</code></a>: Write IOPS
</li>
<li><a name="rate_limit_read_iops"/><a href="#rate_limit_read_iops"><code>rate-limit.read.iops</code></a>: Read IOPS
</li>
<li><a name="rate_limit_read_bps"/><a href="#rate_limit_read_bps"><code>rate-limit.read.bps</code></a>: Read b/s
</li>
<li><a name="rate_limit_write_bps"/><a href="#rate_limit_write_bps"><code>rate-limit.write.bps</code></a>: Write b/s
</li>
</ul>

<h3>NFS Support</h3>
<p>NFS support is still limited (at the time of this writing). To use the NFS
support in its current state you must take a few steps.</p>

<ol>
<li>Ensure &quot;nfs&quot; is the &quot;mount&quot; backend for your policy. <a name="crud"/><a href="#crud"><code>crud</code></a> and <code>snapshot</code>
should be empty.
</li>
<li>Create your volume with the remote mount path specified at create time:

<ul>
<li><a name="docker_volume_create_d_volplugin_name_mypolicy_myvolume_opt_mount_127_0_0_1_mynfsmount"/><a href="#docker_volume_create_d_volplugin_name_mypolicy_myvolume_opt_mount_127_0_0_1_mynfsmount"><code>docker volume create -d volplugin --name mypolicy/myvolume --opt mount=127.0.0.1:/mynfsmount</code></a>
</li>
</ul>
</li>
<li>Mount and continue as normally.
</li>
</ol>

<h2>volcli Reference</h2>
<p><code>volcli</code> controls the <code>volmaster</code>, which in turn is referenced by the
<code>volplugin</code> for local management of storage. Think of volcli as a tap into the
control plane.</p>

<h3>Top-Level Commands</h3>
<p>These commands present CRUD options on their respective sub-sections:</p>

<ul>
<li><a name="volcli_global"/><a href="#volcli_global"><code>volcli global</code></a> manipulates global configuration.
</li>
<li><a name="volcli_policy"/><a href="#volcli_policy"><code>volcli policy</code></a> manipulates policy configuration.
</li>
<li><a name="volcli_volume"/><a href="#volcli_volume"><code>volcli volume</code></a> manipulates volumes.
</li>
<li><a name="volcli_mount"/><a href="#volcli_mount"><code>volcli mount</code></a> manipulates mounts.
</li>
<li><code>volcli help</code> prints the help.

<ul>
<li>Note that for each subcommand, <a name="volcli_help_subcommand_"/><a href="#volcli_help_subcommand_"><code>volcli help [subcommand]</code></a> will print the
help for that command. For multi-level commands, <code>volcli [subcommand] help
[subcommand]</code> will work. Appending <code>--help</code> to any command will print the
help as well.
</li>
</ul>
</li>
</ul>

<h3>Global Commands</h3>

<ul>
<li><a name="volcli_global_upload"/><a href="#volcli_global_upload"><code>volcli global upload</code></a> takes JSON global configuration from the standard input.
</li>
<li><a name="volcli_global_get"/><a href="#volcli_global_get"><code>volcli global get</code></a> retrieves the JSON global configuration.
</li>
</ul>

<h3>Tenant Commands</h3>
<p>Typing <code>volcli policy</code> without arguments will print help for these commands.</p>

<ul>
<li><a name="volcli_policy_upload"/><a href="#volcli_policy_upload"><code>volcli policy upload</code></a> takes a policy name, and JSON configuration from standard input.
</li>
<li><a name="volcli_policy_delete"/><a href="#volcli_policy_delete"><code>volcli policy delete</code></a> removes a policy. Its volumes and mounts will not be removed.
</li>
<li><a name="volcli_policy_get"/><a href="#volcli_policy_get"><code>volcli policy get</code></a> displays the JSON configuration for a policy.
</li>
<li><a name="volcli_policy_list"/><a href="#volcli_policy_list"><code>volcli policy list</code></a> lists the policies etcd knows about.
</li>
</ul>

<h3>Volume Commands</h3>
<p>Typing <code>volcli volume</code> without arguments will print help for these commands.</p>

<ul>
<li><a name="volcli_volume_create"/><a href="#volcli_volume_create"><code>volcli volume create</code></a> will forcefully create a volume just like it was created with
<code>docker volume create</code>. Requires a policy, and volume name.
</li>
<li><a name="volcli_volume_get"/><a href="#volcli_volume_get"><code>volcli volume get</code></a> will retrieve the volume configuration for a given policy/volume combination.
</li>
<li><a name="volcli_volume_list"/><a href="#volcli_volume_list"><code>volcli volume list</code></a> will list all the volumes for a provided policy.
</li>
<li><a name="volcli_volume_list_all"/><a href="#volcli_volume_list_all"><code>volcli volume list-all</code></a> will list all volumes, across policies.
</li>
<li><a name="volcli_volume_remove"/><a href="#volcli_volume_remove"><code>volcli volume remove</code></a> will remove a volume given a policy/volume
combination, deleting the underlying data.  This operation may fail if the
device is mounted, or expected to be mounted.
</li>
<li><a name="volcli_volume_force_remove"/><a href="#volcli_volume_force_remove"><code>volcli volume force-remove</code></a>, given a policy/volume combination, will remove
the data from etcd but not perform any other operations. Use this option with
caution.
</li>
<li><a name="volcli_volume_runtime_get"/><a href="#volcli_volume_runtime_get"><code>volcli volume runtime get</code></a> will retrieve the runtime policy for a given volume
</li>
<li><a name="volcli_volume_runtime_upload"/><a href="#volcli_volume_runtime_upload"><code>volcli volume runtime upload</code></a> will upload (via stdin) the runtime policy for a given volume
</li>
</ul>

<h3>Mount Commands</h3>
<p>Typing <code>volcli mount</code> without arguments will print help for these commands.</p>
<p><strong>Note:</strong> <code>volcli mount</code> cannot control mounts -- this is managed by
<code>volplugin</code> which lives on each host. Eventually there will be support for
pushing operations down to the volplugin, but not yet.</p>

<ul>
<li><a name="volcli_mount_list"/><a href="#volcli_mount_list"><code>volcli mount list</code></a> lists all known mounts in etcd.
</li>
<li><a name="volcli_mount_get"/><a href="#volcli_mount_get"><code>volcli mount get</code></a> obtains specific information about a mount from etcd.
</li>
<li><a name="volcli_mount_force_remove"/><a href="#volcli_mount_force_remove"><code>volcli mount force-remove</code></a> removes the contents from etcd, but does not
attempt to perform any unmounting. This is useful for removing mounts that
for some reason (e.g., host failure, which is not currently satsified by
volplugin)
</li>
</ul>

<h3>Use Commands</h3>
<p>Use commands control the locking system and also provide information about what
is being used by what. Use these commands with caution as they can affect the
stability of the cluster if used improperly.</p>

<ul>
<li><a name="volcli_use_list"/><a href="#volcli_use_list"><code>volcli use list</code></a> will list all uses (mounts, snapshots) in effect.
</li>
<li><a name="volcli_use_get"/><a href="#volcli_use_get"><code>volcli use get</code></a> will get information on a specific use lock.
</li>
<li><a name="volcli_use_force_remove"/><a href="#volcli_use_force_remove"><code>volcli use force-remove</code></a> will force a lock open for a given volume.
</li>
<li><a name="volcli_use_exec"/><a href="#volcli_use_exec"><code>volcli use exec</code></a> will wait for a lock to free, then execute hte command.
</li>
</ul>


			</div>
		</div>
	</div>
</div>